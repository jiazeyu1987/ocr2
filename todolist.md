# SimpleFEM 红/绿波峰逻辑接入 TODO（到 VeinOCRServer3）

## 目标（先对齐）
- [ ] 明确要接入的功能范围：只做“红/绿波峰判定”还是也要做“峰区间检测 + 颜色判定 + 焦点探测 + 规则覆盖”
- [ ] 明确输入是什么：截图（桌面 ROI）/相机帧/已有对比截图(before/after)/离线文件
- [ ] 明确输出是什么：返回给客户端的字段（峰发生时间、红/绿、置信度、原因/日志ID），以及是否需要写 DB
- [ ] 明确实时性：每秒帧率、最大延迟、CPU/GPU 资源上限

## 第 1 步：配置与 ROI 定义（ROI1/ROI2/ROI3 + 焦点区域）
- [ ] 在 `D:\software_data\settings` 增加独立配置段（不要复用现有 `roi1_capture`，避免“对比截图/ocr/峰检测”互相影响）：
  - [ ] `peak_detect.enabled`
  - [ ] `peak_detect.roi1`（用于“找峰区间”的区域）
  - [ ] `peak_detect.roi2`（用于“判红绿”的区域）
  - [ ] `peak_detect.roi3`（用于“辅助规则/纠错/稳定性”的区域，若不用可不配）
  - [ ] `peak_detect.focus_roi`（用于焦点探测的区域；可默认等于 roi2 或 roi1）
  - [ ] 阈值与窗口：`threshold`, `difference_threshold`, `avg_frames`, `silence_frames`, `margin_frames`
  - [ ] 规则覆盖开关（如果需要）：例如 “G1/G2 覆盖”、列差覆盖等
- [ ] 加一个 `peak_debug_log`（类似你现在的 `offline_debug_log`）用于开关详细日志（含 every_n_frames）
- [ ] 做 ROI 合法性校验：越界、宽高太小、与预期分辨率不一致时直接报错并在日志里说明

## 第 2 步：数据获取与特征曲线（把 ROI 变成“可判定的曲线/指标”）
- [ ] 在截图/取帧处增加“同时裁 ROI1/ROI2/ROI3/focus_roi”的能力（同一帧内完成，避免时间不一致）
- [ ] 为 ROI1 计算“峰检测曲线”（一般是灰度均值/亮度均值或归一化强度）
- [ ] 为 ROI2 计算“颜色判定指标”（峰前平均 vs 峰后平均的差值）
- [ ] 为 focus_roi 计算“清晰度/焦点指标”（例如边缘强度/梯度/拉普拉斯方差），并定义合格阈值
- [ ] 记录每帧的时间戳、帧号、关键指标（可采样输出到日志/CSV 便于对照）

## 第 3 步：波峰区间检测（ROI1）
- [ ] 实现“超过阈值的一段连续帧 = 候选峰区间”
- [ ] 实现“峰去重/合并”规则：相距太近按 margin 合并，保留更强的那段
- [ ] 实现“峰间静默”规则：没有达到 silence 的间隔不算新峰
- [ ] 加异常过滤：明显不合理的峰（例如差值绝对值过大、持续帧数过短/过长）直接丢弃并记录原因

## 第 4 步：红/绿判定（ROI2，在峰区间内做）
- [ ] 在每个峰区间内，取峰前 avg_frames 的均值、峰后 avg_frames 的均值做差
- [ ] 差值 >= `difference_threshold` 判绿，否则判红
- [ ] 加“异常差值过滤”（例如 abs(diff) > 某阈值认为是噪声），并把过滤原因写入日志
- [ ] 若启用 ROI3/规则覆盖：按配置对结果做二次修正（并记录“被谁覆盖、为什么覆盖”）

## 第 5 步：焦点探测（决定“这次判定可信不可信”）
- [ ] 给出焦点合格阈值：低于阈值时，不做峰判定或标记结果为“无效/低置信度”
- [ ] 把焦点状态写入结果与日志：focus_score、focus_ok、被拒绝原因
- [ ] 定义降级策略：焦点不合格时是否“继续累计曲线等待变清晰”还是“立即返回不可用”

## 第 6 步：接口对接到当前系统（server.py 的命令/返回）
- [ ] 定义一个新命令（或复用现有命令）触发“波峰检测会话”：开始/停止/查询结果
- [ ] 明确会话生命周期：开始后持续多久、何时自动结束、超时如何处理
- [ ] 返回结构统一：`status`, `peak_found`, `peak_start/end`, `color`, `metrics`, `focus_ok`, `error`
- [ ] 与现有 OCR/对比截图并存：互不阻塞（线程隔离/队列），避免一处卡住影响全局

## 第 7 步：日志与可观测性（上线可定位）
- [ ] 详细日志开关：`peak_debug_log.enabled`
- [ ] 必要日志点：取帧成功/失败、ROI 坐标、每阶段开始/结束、峰区间、红绿判定、覆盖规则、焦点拒绝原因
- [ ] 增加健康度指标：最近一次成功取帧/成功判定时间、连续失败次数（便于 watchdog 决策）

## 第 8 步：验证与回归（必须做，不然上线很难排错）
- [ ] 准备一批录屏/截图样本（含：绿峰、红峰、无峰、虚焦、强噪声、ROI偏移）
- [ ] 做“离线回放”脚本：把样本跑一遍输出判定结果和关键曲线，便于对照
- [ ] 和 SimpleFEM 的输出对齐：同样输入应得到相同峰区间/颜色（允许小误差需事先定义）
- [ ] 生产灰度：先开 debug_log，确认稳定后再降低日志频率

## 第 9 步：打包/部署（如果需要随 PyInstaller 发布）
- [ ] 确认新增依赖是否会影响 PyInstaller（OpenCV/NumPy/自研 .pyd）
- [ ] 把新增配置项写入“打包发布操作步骤”或 README（生产机如何配置 ROI/阈值/日志开关）
- [ ] 上线前做一次“生产机等价环境”验证（分辨率、DPI 缩放、GPU/驱动、权限）

